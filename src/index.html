<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown è½¬ HTML å·¥å…·</title>
    <style>
      /* ç®€å•çš„ CSS ç¾åŒ– */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f6f8fa;
        color: #333;
      }
      h1 { margin-bottom: 30px; font-size: 24px; }
      .btn-container { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; }
      button {
        padding: 15px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        font-weight: bold;
      }
      .btn-primary { background-color: #007bff; color: white; }
      .btn-primary:hover { background-color: #0056b3; }
      .btn-secondary { background-color: #28a745; color: white; }
      .btn-secondary:hover { background-color: #1e7e34; }
      #status { margin-top: 20px; font-size: 14px; color: #666; text-align: center; white-space: pre-wrap;}
    </style>
  </head>
  <body>
    <h1>Markdown è¡¨æ ¼è½¬ HTML</h1>
    
    <div class="btn-container">
      <button class="btn-primary" id="btn-file">ğŸ“ é€‰æ‹© Markdown æ–‡ä»¶</button>
      <button class="btn-secondary" id="btn-clipboard">ğŸ“‹ ä»å‰ªè´´æ¿è¯»å–å¹¶ä¿å­˜</button>
    </div>

    <div id="status"></div>

    <script type="module">
      // ----------------------------------------------------
      // 1. å¯¼å…¥ä¿®å¤ï¼šæ·»åŠ äº† missing çš„ 'message'
      // ----------------------------------------------------
      import { open, save, message } from '@tauri-apps/plugin-dialog';
      import { readTextFile, writeTextFile } from '@tauri-apps/plugin-fs';
      import { readText } from '@tauri-apps/plugin-clipboard-manager';
      
      // æ³¨æ„ï¼šTauri v2 çš„ api/core ä¸»è¦æ˜¯ invokeï¼Œè¿™é‡Œæš‚æ—¶æ²¡ç”¨åˆ° invokeï¼Œä½†ç•™ç€æ— å¦¨
      import { invoke } from '@tauri-apps/api/core'; 

      const statusDiv = document.getElementById('status');

      // ==========================================
      // æ ¸å¿ƒé€»è¾‘ï¼šJS è§£æ Markdown è¡¨æ ¼
      // ==========================================
      function convertMdToHtml(mdContent, fileNameBase) {
        try {
          // 1. æ‹†åˆ†è¡Œå¹¶æ¸…æ´—
          let lines = mdContent.split('\n');
          // ç§»é™¤ Markdown åˆ†éš”çº¿ (åŒ…å« --- çš„è¡Œ) å’Œç©ºè¡Œ
          lines = lines.filter(line => !line.includes('---') && line.trim() !== '');

          if (lines.length < 2) throw new Error("å†…å®¹ä¼¼ä¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");

          // 2. è§£æè¡¨å¤´
          // ä½¿ç”¨ filter(h => h !== '') æ¥å»é™¤ split äº§ç”Ÿçš„é¦–å°¾ç©ºå­—ç¬¦ä¸²
          const headers = lines[0].split('|').map(h => h.trim()).filter(h => h !== '');
          
          // æ‰¾åˆ°æˆ‘ä»¬å…³å¿ƒçš„åˆ—çš„ç´¢å¼•
          const targetCols = ['mainTaskId', 'time', 'userId', 'output'];
          const colIndices = {};
          
          headers.forEach((h, index) => {
            if (targetCols.includes(h)) colIndices[h] = index;
          });

          // 3. è§£ææ•°æ®è¡Œ
          const dataRows = [];
          
          for (let i = 1; i < lines.length; i++) {
            // ----------------------------------------------------
            // è§£æä¼˜åŒ–ï¼šæ•°æ®è¡Œçš„å¤„ç†æ–¹å¼å¿…é¡»å’Œè¡¨å¤´å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™ç´¢å¼•ä¼šé”™ä½
            // ----------------------------------------------------
            const rawCells = lines[i].split('|').map(c => c.trim()).filter(c => c !== '');
            
            // å¦‚æœè¿™ä¸€è¡Œæ˜¯ç©ºçš„æˆ–è€…æ²¡æ•°æ®ï¼Œè·³è¿‡
            if (rawCells.length === 0) continue;

            const rowData = {};
            
            targetCols.forEach(col => {
               // æ ¹æ®è¡¨å¤´è®°å½•çš„ index å»å–æ•°æ®
               const idx = colIndices[col];
               if (idx !== undefined && rawCells[idx] !== undefined) {
                   rowData[col] = rawCells[idx];
               } else {
                   rowData[col] = '';
               }
            });

            // 4. å¤„ç† Output å›¾ç‰‡ JSON
            rowData.images = [];
            if (rowData['output']) {
              try {
                // æœ‰äº› Markdown å†…å®¹é‡Œçš„å¼•å·å¯èƒ½è¢«è½¬ä¹‰ï¼Œç®€å•æ¸…æ´—ä¸€ä¸‹
                const jsonStr = rowData['output'].replace(/\\"/g, '"'); 
                const parsed = JSON.parse(jsonStr);
                if (Array.isArray(parsed)) {
                  rowData.images = parsed;
                }
              } catch (e) {
                // å°è¯•ç›´æ¥è§£æå¤±è´¥ï¼Œè¯´æ˜å¯èƒ½ä¸æ˜¯æ ‡å‡† JSONï¼Œæˆ–è€…æ˜¯ç©º
                // ç”Ÿäº§ç¯å¢ƒå¯ä»¥åŠ æ›´å¤šå®¹é”™ï¼Œè¿™é‡Œä¿æŒç®€å•
              }
            }
            dataRows.push(rowData);
          }

          // è®¡ç®—æœ€å¤§å›¾ç‰‡æ•°åˆ—æ•°
          const maxImgCount = Math.max(...dataRows.map(r => r.images.length), 0);

          // 5. ç”Ÿæˆ HTML è¡¨æ ¼
          let tableHtml = '<table><thead><tr>';
          // å›ºå®šåˆ—å¤´
          ['mainTaskId', 'time', 'userId'].forEach(col => {
             if (colIndices[col] !== undefined) tableHtml += `<th>${col}</th>`;
          });
          // å›¾ç‰‡åˆ—å¤´
          for (let k = 0; k < maxImgCount; k++) {
            tableHtml += `<th>Output Image ${k+1}</th>`;
          }
          tableHtml += '</tr></thead><tbody>';

          // æ•°æ®è¡Œ
          dataRows.forEach(row => {
            tableHtml += '<tr>';
            ['mainTaskId', 'time', 'userId'].forEach(col => {
              if (colIndices[col] !== undefined) tableHtml += `<td>${row[col] || ''}</td>`;
            });

            // å›¾ç‰‡åˆ—
            for (let k = 0; k < maxImgCount; k++) {
              const imgUrl = row.images[k];
              let cellContent = '';
              if (imgUrl) {
                // æ‡’åŠ è½½ + åŸå›¾ + Zoom æ ·å¼
                cellContent = `
                  <a href="${imgUrl}" target="_blank" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                    <img src="${imgUrl}" loading="lazy" width="150" 
                         style="border-radius:5px; border:1px solid #ccc; object-fit: cover; height: 150px; cursor: zoom-in;">
                  </a>
                `;
              }
              tableHtml += `<td>${cellContent}</td>`;
            }
            tableHtml += '</tr>';
          });
          tableHtml += '</tbody></table>';

          // 6. æœ€ç»ˆ HTML ç»“æ„
          return `
            <html>
            <head>
              <meta charset='utf-8'>
              <style>
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; }
                th { background-color: #f2f2f2; padding: 10px; text-align: left; border: 1px solid #ddd; position: sticky; top: 0; z-index: 10;}
                td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                tr:hover { background-color: #f1f1f1; }
              </style>
            </head>
            <body>
              <h2>å¤„ç†ç»“æœ: ${fileNameBase}</h2>
              ${tableHtml}
            </body>
            </html>
          `;
        } catch (error) {
          throw error;
        }
      }

      // ==========================================
      // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆè¾“å‡ºæ–‡ä»¶å (è·¨å¹³å°å…¼å®¹)
      // ==========================================
      function getOutputPath(originalPath) {
        // æ‰¾åˆ°æœ€åä¸€ä¸ªç‚¹çš„ä½ç½®
        const lastDotIndex = originalPath.lastIndexOf('.');
        if (lastDotIndex === -1) {
            return originalPath + "_output.html";
        }
        // æˆªå–ç‚¹ä¹‹å‰çš„éƒ¨åˆ† + åç¼€
        return originalPath.substring(0, lastDotIndex) + "_output.html";
      }

      // è¾…åŠ©å‡½æ•°ï¼šä»è·¯å¾„è·å–æ–‡ä»¶å
      function getFileNameBase(originalPath) {
        // å…¼å®¹ Windows (\) å’Œ Unix (/) åˆ†éš”ç¬¦
        const separator = originalPath.includes('\\') ? '\\' : '/';
        const fullName = originalPath.split(separator).pop();
        const lastDotIndex = fullName.lastIndexOf('.');
        return lastDotIndex === -1 ? fullName : fullName.substring(0, lastDotIndex);
      }

      // ==========================================
      // äº‹ä»¶ç»‘å®š
      // ==========================================

      // åŠŸèƒ½ 1ï¼šé€‰æ‹©æ–‡ä»¶
      document.getElementById('btn-file').addEventListener('click', async () => {
        try {
          const selected = await open({
            filters: [{ name: 'Markdown', extensions: ['md', 'txt'] }]
          });

          if (selected) {
            statusDiv.textContent = "æ­£åœ¨å¤„ç†...";
            
            // è¯»å–æ–‡ä»¶
            const content = await readTextFile(selected);
            
            // è·å–æ–‡ä»¶åä¿¡æ¯
            const fileBase = getFileNameBase(selected);
            const outputName = getOutputPath(selected);

            // è½¬æ¢
            const html = convertMdToHtml(content, fileBase);

            // å†™å…¥
            await writeTextFile(outputName, html);

            statusDiv.textContent = "å®Œæˆï¼";
            await message(`æˆåŠŸï¼\nå·²ä¿å­˜è‡³: ${outputName}`);
            statusDiv.textContent = "";
          }
        } catch (err) {
          console.error(err);
          await message(`é”™è¯¯: ${err}`, { kind: 'error' }); // Tauri v2 message ç±»å‹å‚æ•°å˜äº†ï¼Œä¹Ÿå¯ä»¥ä¸ä¼ 
          statusDiv.textContent = "å‘ç”Ÿé”™è¯¯";
        }
      });

      // åŠŸèƒ½ 2ï¼šå‰ªè´´æ¿
      document.getElementById('btn-clipboard').addEventListener('click', async () => {
        try {
          const content = await readText();
          if (!content || !content.trim()) {
            await message('å‰ªè´´æ¿ä¸ºç©ºï¼');
            return;
          }

          // è¯¢é—®ä¿å­˜ä½ç½® (ä¿å­˜ .md)
          const savePath = await save({
            filters: [{ name: 'Markdown', extensions: ['md'] }],
            defaultPath: 'clipboard_data.md'
          });

          if (savePath) {
            statusDiv.textContent = "æ­£åœ¨å¤„ç†...";
            // 1. ä¿å­˜ MD
            await writeTextFile(savePath, content);

            // 2. è½¬æ¢å¹¶ä¿å­˜ HTML
            const fileBase = getFileNameBase(savePath);
            const outputName = getOutputPath(savePath);

            const html = convertMdToHtml(content, fileBase);
            await writeTextFile(outputName, html);

            statusDiv.textContent = "å®Œæˆï¼";
            await message(`æˆåŠŸï¼\nå·²ä¿å­˜è‡³: ${outputName}`);
            statusDiv.textContent = "";
          }

        } catch (err) {
          console.error(err);
          await message(`é”™è¯¯: ${err}`);
          statusDiv.textContent = "å‘ç”Ÿé”™è¯¯";
        }
      });
    </script>
  </body>
</html>